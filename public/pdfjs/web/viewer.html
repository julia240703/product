<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF Viewer</title>

  <!-- CSS eksternal -->
  <link rel="stylesheet" href="/pdfjs/web/custom-viewer.css?v=2">
</head>
<body>
  <div class="topbar">
    <button class="btn" id="zoomOut" title="Zoom out">‚àí</button>
    <button class="btn" id="zoomIn"  title="Zoom in">+</button>

    <span class="sep"></span>

    <div class="pagebox">
      <input id="pageNumber" type="number" min="1" value="1" title="Halaman" inputmode="none" />
      <span id="pageCount">of 0</span>
    </div>

    <span class="sep"></span>
    <button class="btn" id="fit" title="Fit width">‚§¢</button>

    <div class="grow"></div>

    <button class="btn" id="searchBtn" title="Find (Ctrl/‚åò+F)">üîç</button>
    <button class="btn" id="fsBtn" title="Fullscreen">‚õ∂</button>
  </div>

  <!-- Findbar: default tersembunyi -->
  <div class="findbar hidden" id="findbar">
    <input id="findInput" type="search" placeholder="Cari..." inputmode="none" autocomplete="off" />
    <span class="find-count" id="findCount">0/0</span>
    <button class="btn" id="findPrev" title="Sebelumnya">‚Üë</button>
    <button class="btn" id="findNext" title="Berikutnya">‚Üì</button>
    <button class="btn" id="findClose" title="Tutup">‚úï</button>
  </div>

  <div class="viewer" id="viewer"></div>

  <script src="../build/pdf.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = location.origin + '/pdfjs/build/pdf.worker.min.js';

    const q = new URLSearchParams(location.search);
    let fileUrl = q.get('file') || '';
    try { fileUrl = decodeURIComponent(fileUrl); } catch {}
    if (!fileUrl) {
      document.getElementById('viewer').innerHTML =
        '<div class="msg">Tidak ada parameter <code>?file=</code>.</div>';
      throw new Error('no file param');
    }
    if (fileUrl.startsWith('/')) fileUrl = location.origin + fileUrl;

    const viewer   = document.getElementById('viewer');
    const pageBox  = document.getElementById('pageNumber');
    const pageCnt  = document.getElementById('pageCount');
    const findbar  = document.getElementById('findbar');
    const findInput= document.getElementById('findInput');
    const findCount= document.getElementById('findCount');

    let pdf=null, scale=1.2, rotation=0, numPages=0;
    let pageTexts=[], pageEls=[]; // index 1-based
    let results=[], activeIndex=-1;

    async function renderPage(p){
      const page = await pdf.getPage(p);
      const pageRotation = page.rotate || 0;
      const viewport = page.getViewport({
        scale,
        rotation:(pageRotation+rotation)%360
      });

      let wrap = pageEls[p];
      if (!wrap){
        wrap = document.createElement('div');
        wrap.className='pageWrap';
        pageEls[p] = wrap;
        viewer.appendChild(wrap);
      }
      wrap.style.width  = viewport.width  + 'px';
      wrap.style.height = viewport.height + 'px';

      let canvas = wrap.querySelector('canvas');
      if(!canvas){ canvas=document.createElement('canvas'); wrap.appendChild(canvas); }
      canvas.width  = viewport.width;
      canvas.height = viewport.height;

      let tLayer = wrap.querySelector('.textLayer');
      if(!tLayer){ tLayer=document.createElement('div'); tLayer.className='textLayer'; wrap.appendChild(tLayer); }
      tLayer.innerHTML='';

      const ctx = canvas.getContext('2d',{alpha:false});
      await page.render({ canvasContext:ctx, viewport }).promise;

      if(!pageTexts[p]) pageTexts[p] = await page.getTextContent();
      const { items, styles } = pageTexts[p];

      items.forEach(item=>{
        const span = document.createElement('span');
        span.textContent = item.str;

        // posisi/transform bawaan textLayer
        const tx = pdfjsLib.Util.transform(
          pdfjsLib.Util.transform(viewport.transform, item.transform),
          [1,0,0,-1,0,0]
        );
        span.style.transform  = `matrix(${tx[0]},${tx[1]},${tx[2]},${tx[3]},${tx[4]},${tx[5]})`;

        // ukuran & font
        const s = styles[item.fontName];
        span.style.fontSize   = (item.height * viewport.scale) + 'px';
        span.style.fontFamily = s?.fontFamily || 'sans-serif';

        tLayer.appendChild(span);
      });
    }

    async function renderPDF(){
      const head = await fetch(fileUrl,{method:'HEAD'});
      if(!head.ok){
        viewer.innerHTML = `<div class="msg error">Gagal memuat PDF (HTTP ${head.status}).</div>`;
        return;
      }

      pdf = await pdfjsLib.getDocument({
        url:fileUrl, disableRange:true, disableStream:true, disableAutoFetch:true
      }).promise;

      numPages = pdf.numPages;
      pageCnt.textContent = `of ${numPages}`;
      viewer.innerHTML='';
      pageEls=new Array(numPages+1);

      const tasks=[]; for(let p=1;p<=numPages;p++) tasks.push(renderPage(p));
      await Promise.all(tasks);
    }

    function rerender(){
      clearSearch();
      viewer.innerHTML='';
      pageEls=[];
      renderPDF().then(attachObserver);
    }
    function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

    async function fitWidth(){
      const page = await pdf.getPage(1);
      const vp   = page.getViewport({ scale:1, rotation:(page.rotate||0+rotation)%360 });
      scale = Math.max(0.3, (viewer.clientWidth-32)/vp.width);
      rerender();
    }

    document.getElementById('zoomIn').addEventListener('click',  ()=>{ scale+=0.15; rerender(); });
    document.getElementById('zoomOut').addEventListener('click', ()=>{ scale=Math.max(0.3,scale-0.15); rerender(); });
    document.getElementById('fit').addEventListener('click',     ()=>{ if(pdf) fitWidth(); });

    document.getElementById('fsBtn').addEventListener('click', ()=>{
      const doc=document, el=doc.documentElement;
      const inFs=doc.fullscreenElement||doc.webkitFullscreenElement||doc.msFullscreenElement||doc.mozFullScreenElement;
      if(!inFs){ (el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen||el.mozRequestFullScreen).call(el); }
      else{ (doc.exitFullscreen||doc.webkitExitFullscreen||doc.msExitFullscreen||doc.mozCancelFullScreen).call(doc); }
    });

    function jumpToPage(n){
      const num = clamp(parseInt(n||'1',10),1,numPages);
      const el=pageEls[num];
      if(el) el.scrollIntoView({behavior:'smooth',block:'start'});
      pageBox.value=num;
    }
    pageBox.addEventListener('change', ()=> jumpToPage(pageBox.value));

    // observer untuk update ‚ÄúpageNumber‚Äù saat scroll
    const io=new IntersectionObserver(entries=>{
      let top=null, topY=Infinity;
      entries.forEach(e=>{
        if(!e.isIntersecting) return;
        const r=e.target.getBoundingClientRect();
        if(r.top<topY){topY=r.top; top=e.target;}
      });
      if(top){
        const idx=pageEls.indexOf(top);
        if(idx>0) pageBox.value=idx;
      }
    }, {root:viewer, threshold:[0,.01,.1,.2,.3,.4,.5]});
    const attachObserver=()=>pageEls.forEach(el=>{ if(el) io.observe(el); });

    /* ===== FIND ===== */
    function clearMarksInSpan(span){
      const marks = span.querySelectorAll('mark.hl');
      if(!marks.length) return;
      marks.forEach(m=>{
        const t=document.createTextNode(m.textContent);
        m.replaceWith(t);
      });
      span.normalize();
    }
    function clearSearch(){
      results.forEach(r=> r.marks.forEach(m=>{
        if(m.parentNode){ const t=document.createTextNode(m.textContent); m.replaceWith(t); }
      }));
      results=[]; activeIndex=-1; updateCounter();
    }
    function buildPageMap(wrap){
      const spans=[...wrap.querySelectorAll('.textLayer span')];
      let pos=0; const pieces=[]; const map=[];
      spans.forEach(sp=>{
        const txt=sp.textContent||'';
        pieces.push(txt);
        map.push({node:sp, start:pos, end:pos+txt.length});
        pos+=txt.length; pieces.push(' '); pos+=1;
      });
      return { full: pieces.join(''), spans:map };
    }
    function markInNode(node, start, end){
      const txt=node.textContent;
      const a=txt.slice(0,start), b=txt.slice(start,end), c=txt.slice(end);
      const mark=document.createElement('mark'); mark.className='hl'; mark.textContent=b;
      // supaya ukuran/posisi persis: mark inline di dalam span yang SUDAH ditransform
      node.replaceChildren(document.createTextNode(a), mark, document.createTextNode(c));
      return mark;
    }
    function highlightRangeOnPage(wrap, map, start, len){
      const end = start + len, marks=[];
      map.spans.forEach(seg=>{
        if(seg.end<=start || seg.start>=end) return;
        const s=Math.max(0,start-seg.start);
        const e=Math.min(seg.end,end)-seg.start;
        clearMarksInSpan(seg.node);
        marks.push( markInNode(seg.node, s, e) );
      });
      return marks;
    }
    function doSearch(term){
      clearSearch();
      const query=(term||'').trim(); if(!query) return;
      const L=query.length, qLower=query.toLowerCase();

      pageEls.forEach((wrap, pageIdx)=>{
        if(!wrap) return;
        const map=buildPageMap(wrap);
        const full=map.full.toLowerCase();
        let idx=full.indexOf(qLower,0);
        while(idx!==-1){
          const marks=highlightRangeOnPage(wrap,map,idx,L);
          if(marks.length) results.push({ page:pageIdx, marks, anchor:marks[0] });
          idx=full.indexOf(qLower, idx+L);
        }
      });

      updateCounter();
      if(results.length){ goTo(0); }
    }
    function updateCounter(){
      const total=results.length||0;
      const cur=total?(activeIndex+1):0;
      findCount.textContent = `${cur}/${total}`;
      try { parent.postMessage({ type:'PDF_FIND_UPDATE', payload:{ cur, total } }, '*'); } catch(_){}
    }
    function goTo(i){
      if(!results.length) return;
      results.forEach(r=> r.marks.forEach(m=>m.classList.remove('active')));
      activeIndex = (i + results.length) % results.length;
      const r=results[activeIndex], wrap=pageEls[r.page];
      if(wrap){
        wrap.scrollIntoView({behavior:'smooth', block:'center'});
        wrap.classList.add('hitFlash');
        setTimeout(()=>wrap.classList.remove('hitFlash'), 900);
        const p=pageEls.indexOf(wrap); if(p>0) pageBox.value=p;
      }
      r.marks.forEach(m=>m.classList.add('active'));
      updateCounter();
    }

    // tombol findbar
    document.getElementById('findPrev').addEventListener('click', ()=>{ if(results.length) goTo(activeIndex-1); });
    document.getElementById('findNext').addEventListener('click', ()=>{ if(results.length) goTo(activeIndex+1); });
    document.getElementById('findClose').addEventListener('click', ()=>{
      clearSearch();
      findbar.classList.add('hidden');
      try{ parent.postMessage({type:'PDF_FIND_CLOSE'},'*'); }catch(_){}
    });

    /* ===== BRIDGE parent <-> iframe ===== */
    window.addEventListener('message', (e)=>{
      const data = e.data || {};
      switch (data.type) {
        case 'PDF_FIND_EXECUTE': {
          const term = (data.payload?.term || '').trim();
          findbar.classList.remove('hidden');   // pastikan tampil
          findInput.value = term;
          findInput.focus();
          doSearch(term);
          break;
        }
        case 'PDF_FIND_NEXT':
          if (results.length) goTo(activeIndex + 1);
          break;
        case 'PDF_FIND_PREV':
          if (results.length) goTo(activeIndex - 1);
          break;
        case 'PDF_FIND_CLOSE':
          clearSearch();
          findbar.classList.add('hidden');
          break;
        case 'PDF_PAGE_JUMP':
          jumpToPage(data.payload?.page || 1);
          break;
        case 'PDF_OSK_OPEN_TEXT':   // kalau parent hanya mau membuka OSK
          findbar.classList.remove('hidden');
          findInput.focus();
          break;
      }
    });

    // klik üîç / Ctrl+F ‚Üí tampilkan findbar + minta OSK teks dari parent
    document.getElementById('searchBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      findbar.classList.remove('hidden');
      findInput.focus();
      try { parent.postMessage({ type:'PDF_OSK_OPEN_TEXT' }, '*'); } catch(_){}
    });
    window.addEventListener('keydown', (e)=>{
      const isMac=/Mac/i.test(navigator.platform);
      if((isMac?e.metaKey:e.ctrlKey) && e.key.toLowerCase()==='f'){
        e.preventDefault();
        findbar.classList.remove('hidden');
        findInput.focus();
        try { parent.postMessage({ type:'PDF_OSK_OPEN_TEXT' }, '*'); } catch(_){}
      }
    });

    // Fokus page number ‚Üí minta parent tampilkan numpad
    function askParentNumpad(){
      try {
        parent.postMessage({
          type:'PDF_OSK_OPEN_NUM',
          payload:{ current: pageBox.value, max: numPages }
        }, '*');
      } catch(_){}
    }
    pageBox.addEventListener('focus', askParentNumpad);
    pageBox.addEventListener('click', askParentNumpad);

    // vh fix
    const setVH = () => document.documentElement.style.setProperty('--vh', window.innerHeight + 'px');
    setVH(); addEventListener('resize', setVH);

    renderPDF().then(attachObserver).catch(err=>{
      console.error(err);
      viewer.innerHTML = `<div class="msg error">Gagal memuat PDF.<br><small>${(err && err.message) || err}</small></div>`;
    });
  </script>
</body>
</html>